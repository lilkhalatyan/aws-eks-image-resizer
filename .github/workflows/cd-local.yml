name: cd-local

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build_push_validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    env:
      REG_OWNER: ${{ github.repository_owner }}
      SHA: ${{ github.sha }}
      API_IMG: ghcr.io/${{ github.repository_owner }}/image-resizer-api:${{ github.sha }}
      WORKER_IMG: ghcr.io/${{ github.repository_owner }}/image-resizer-worker:${{ github.sha }}
      AWS_REGION: us-west-2
      INPUT_BUCKET: image-resizer-input
      OUTPUT_BUCKET: image-resizer-output
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Login to GHCR
        run: echo "${{ github.token }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Build & push API
        run: |
          set -euxo pipefail
          docker build -t "$API_IMG" api
          docker push "$API_IMG"

      - name: Build & push Worker
        run: |
          set -euxo pipefail
          docker build -t "$WORKER_IMG" worker
          docker push "$WORKER_IMG"

      - name: Create kind cluster
        uses: helm/kind-action@v1.10.0

      # Install base tools (exclude awscli here)
      - name: Install tools (jq, nc, curl, unzip, apt helpers)
        run: |
          set -euxo pipefail
          for i in {1..5}; do
            sudo rm -f /var/lib/dpkg/lock-frontend /var/lib/apt/lists/lock || true
            sudo apt-get update && sudo apt-get install -y \
              jq netcat-openbsd curl unzip apt-transport-https ca-certificates gnupg && break
            echo "APT install failed, retrying in 10s..."
            sleep 10
          done

      # Install AWS CLI v2 from official bundle
      - name: Install AWS CLI v2
        run: |
          set -euxo pipefail
          curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install
          aws --version

      # Install Helm via APT with retries (no azure/setup-helm)
      - name: Install Helm via APT (with retries)
        run: |
          set -euxo pipefail
          for i in {1..5}; do
            curl -fsSL https://baltocdn.com/helm/signing.asc | sudo gpg --dearmor -o /usr/share/keyrings/helm.gpg && \
            echo "deb [signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" \
              | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list && break || sleep 5
          done
          for i in {1..5}; do
            sudo apt-get update && sudo apt-get install -y helm && break || (echo "retrying helm install"; sleep 10)
          done
          helm version

      - name: Deploy chart with images
        run: |
          set -euxo pipefail
          helm upgrade --install image-resizer deploy/charts/image-resizer \
            --namespace default --create-namespace \
            --set image.api="${API_IMG}" \
            --set image.worker="${WORKER_IMG}" \
            --set env.AWS_DEFAULT_REGION="${AWS_REGION}" \
            --set env.INPUT_BUCKET="${INPUT_BUCKET}" \
            --set env.OUTPUT_BUCKET="${OUTPUT_BUCKET}" \
            --set awsEndpoint=http://localstack:4566

          kubectl wait --for=condition=available --timeout=300s deploy/localstack

      - name: Bootstrap Local AWS + patch ConfigMap
        run: |
          set -euxo pipefail
          kubectl port-forward svc/localstack 4566:4566 >/tmp/ls-pf.log 2>&1 &
          PF_LS=$!
          for i in {1..60}; do nc -z localhost 4566 && break || sleep 1; done

          export AWS_ENDPOINT_URL=http://localhost:4566
          aws --endpoint-url "$AWS_ENDPOINT_URL" s3 mb "s3://${INPUT_BUCKET}" || true
          aws --endpoint-url "$AWS_ENDPOINT_URL" s3 mb "s3://${OUTPUT_BUCKET}" || true
          aws --endpoint-url "$AWS_ENDPOINT_URL" sqs create-queue --queue-name image-resizer-jobs >/dev/null 2>&1 || true
          QURL=$(aws --endpoint-url "$AWS_ENDPOINT_URL" sqs get-queue-url --queue-name image-resizer-jobs --query 'QueueUrl' --output text)
          echo "QUEUE_URL=$QURL"
          echo "QUEUE_URL=$QURL" >> $GITHUB_ENV

          kubectl patch configmap image-resizer-config -p "{\"data\":{\"QUEUE_URL\":\"$QURL\"}}"
          kubectl rollout restart deploy/api
          kubectl rollout restart deploy/worker

          kill $PF_LS || true

      - name: Wait for API and Worker
        run: |
          set -euxo pipefail
          kubectl wait --for=condition=available --timeout=300s deploy/api
          kubectl wait --for=condition=available --timeout=300s deploy/worker
          kubectl get pods -o wide

      - name: Smoke test (upload & verify)
        run: |
          set -euxo pipefail
          python - <<'PY'
          from PIL import Image
          im = Image.new("RGB", (1024, 768), (200, 120, 40))
          im.save("sample.jpg", "JPEG", quality=85)
          print("wrote sample.jpg")
          PY

          kubectl port-forward deploy/api 8080:8080 >/tmp/api-pf.log 2>&1 &
          PF_API=$!
          for i in {1..60}; do nc -z localhost 8080 && break || sleep 1; done

          curl -s -F "file=@sample.jpg" http://localhost:8080/upload | tee /tmp/upload.json
          JOB=$(jq -r .job_id /tmp/upload.json || echo "")
          echo "JOB=$JOB"

          kubectl port-forward svc/localstack 4566:4566 >/tmp/ls2-pf.log 2>&1 &
          PF2=$!
          for i in {1..60}; do nc -z localhost 4566 && break || sleep 1; done

          export AWS_ENDPOINT_URL=http://localhost:4566
          aws --endpoint-url "$AWS_ENDPOINT_URL" s3 ls "s3://${OUTPUT_BUCKET}/output/" || true
          if [ -n "$JOB" ]; then
            aws --endpoint-url "$AWS_ENDPOINT_URL" s3 cp "s3://${OUTPUT_BUCKET}/output/${JOB}.jpg" resized.jpg || true
          fi

          kill $PF_API || true
          kill $PF2 || true

      - name: Upload resized image artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: resized-image
          path: resized.jpg
          if-no-files-found: ignore
